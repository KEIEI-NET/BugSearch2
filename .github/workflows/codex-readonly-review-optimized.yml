name: Readonly Code Review (Optimized)

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’30åˆ†ã«è¨­å®š

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install chromadb openai scikit-learn joblib regex
      continue-on-error: false

    - name: Create .env file
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
        echo "OPENAI_MODEL=${{ secrets.OPENAI_MODEL || 'gpt-5' }}" >> .env

    - name: Index repository
      run: |
        echo "ğŸ” Indexing repository files..."
        python codex_review_optimized.py index .
        echo "âœ… Indexing completed"

    - name: Create TF-IDF vectors (optional)
      run: |
        echo "ğŸ“Š Creating TF-IDF vectors for better search..."
        python codex_review_optimized.py vectorize --index .advice_index.jsonl || echo "âš ï¸ TF-IDF creation failed, will use naive search"
      continue-on-error: true

    - name: Run comprehensive advice (all files)
      run: |
        echo "ğŸ¤– Running comprehensive code review on all files..."
        mkdir -p reports

        # å…¨ä½“çš„ãªæ¨ªæ–­ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§100ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        python codex_review_optimized.py advise \
          --mode hybrid \
          --topk 100 \
          --out reports/advise.md

        echo "âœ… Code review completed"
      env:
        PYTHONUNBUFFERED: 1  # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°å‡ºåŠ›

    - name: Generate PR-specific review
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ” Analyzing PR-specific changes..."

        # PRå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
        git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
        echo "## PRå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«" > reports/pr_specific.md
        echo "" >> reports/pr_specific.md
        cat changed_files.txt >> reports/pr_specific.md

        # ä¸»è¦ãªæ‡¸å¿µäº‹é …ã‚’æ¤œç´¢
        for keyword in "é‡‘é¡" "å°åˆ·" "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹" "UI"; do
          python codex_review_optimized.py query "$keyword" \
            --mode hybrid \
            --topk 10 \
            --out reports/pr_${keyword}.md || echo "Query for $keyword failed"
        done
      continue-on-error: true

    - name: Create summary report
      run: |
        echo "ğŸ“ Creating summary report..."

        # ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        echo "# ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼" > reports/summary.md
        echo "" >> reports/summary.md
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')" >> reports/summary.md
        echo "" >> reports/summary.md

        # ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰é‡è¦éƒ¨åˆ†ã‚’æŠ½å‡º
        if [ -f reports/advise.md ]; then
          echo "## ğŸ“Š é‡ç‚¹ãƒã‚§ãƒƒã‚¯çµæœ" >> reports/summary.md
          head -n 100 reports/advise.md >> reports/summary.md
        fi

        # å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«è­¦å‘Š
        if [ -f reports/large_files_over_limit.log ]; then
          echo "" >> reports/summary.md
          echo "## âš ï¸ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«" >> reports/summary.md
          head -n 20 reports/large_files_over_limit.log >> reports/summary.md
        fi

    - name: Upload review artifacts
      uses: actions/upload-artifact@v3
      with:
        name: readonly-advice-optimized
        path: reports/
        retention-days: 30

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
          let comment = '## ğŸ¤– Readonly Code Review (GPT-5 Optimized)\n\n';

          try {
            const summary = fs.readFileSync('reports/summary.md', 'utf8');
            // æœ€å¤§æ–‡å­—æ•°åˆ¶é™ï¼ˆGitHub PRã‚³ãƒ¡ãƒ³ãƒˆã®åˆ¶é™ï¼‰
            const maxLength = 65000;
            if (summary.length > maxLength) {
              comment += summary.substring(0, maxLength) + '\n\n... (çœç•¥)';
            } else {
              comment += summary;
            }
          } catch (error) {
            comment += 'âš ï¸ ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          }

          comment += '\n\n---\n';
          comment += 'ğŸ“ **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ**: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ `readonly-advice-optimized` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚\n';
          comment += 'ğŸ”§ **è¨­å®š**: GPT-5, ãƒãƒƒãƒå‡¦ç†(10ãƒ•ã‚¡ã‚¤ãƒ«/ãƒãƒƒãƒ), ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ240ç§’\n';

          // PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name: Set job status
      if: always()
      run: |
        if [ -f reports/advise.md ]; then
          echo "âœ… Review completed successfully"
          exit 0
        else
          echo "âŒ Review failed to generate report"
          exit 1
        fi