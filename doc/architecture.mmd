graph TB
    %% コードレビューシステム アーキテクチャ図 v4.0.0

    subgraph input["入力層"]
        USER[ユーザー]
        CLI[コマンドライン]
        ENV["環境設定 .env"]
        BATCH_SCRIPT["バッチファイル run_complete_full_analysis.bat"]
    end

    subgraph main["メインシステム - インデックス処理"]
        MAIN["codex_review_severity.py メインコントローラー v4.0"]
        INDEX["インデックス作成 --src-dir対応"]
        ENCODE["エンコーディング検出 chardet統合"]
        FILTER["ファイルフィルター 言語/サイズ"]
    end

    subgraph analysis["メインシステム - 解析エンジン"]
        RULES["ルールベース解析 全6,089+ファイル対象"]
        SEVERITY["重要度判定 危険度スコアリング"]
        PARALLEL["並列AI分析 extract_and_batch_parallel_enhanced.py 10 workers"]
    end

    subgraph dataproc["メインシステム - データ処理"]
        VECTOR["ベクトル化 TF-IDF"]
        SEARCH["類似検索 scikit-learn"]
        CACHE["MD5キャッシュ .cache/analysis/"]
    end

    subgraph reportgen["メインシステム - レポート生成"]
        COMPLETE["完全レポート生成 --complete-all対応"]
        MARKDOWN["Markdown出力 UTF-8 BOMなし"]
    end

    subgraph v4apply["v4.0新機能 - 自動適用層"]
        APPLY_TOOL["apply_improvements_from_report.py 自動改善適用ツール"]
    end

    subgraph v4security["v4.0新機能 - セキュリティ層"]
        PATH_VAL["パストラバーサル防止 ホワイトリスト方式"]
        TOCTOU["TOCTOU対策 lstat検証"]
        ATOMIC["アトミック更新 tempfile+fsync"]
    end

    subgraph v4encoding["v4.0新機能 - エンコーディング層"]
        BOM_DETECT["BOM自動検出 UTF-8/UTF-16"]
        CHARDET["chardet統合 confidence>0.7"]
        FALLBACK["多段階フォールバック UTF-8→CP932→Shift_JIS"]
    end

    subgraph v4safe["v4.0新機能 - 安全機能"]
        BACKUP["タイムスタンプバックアップ メタデータJSON"]
        ROLLBACK["ロールバック機能 メタデータベース復元"]
        FILELOCK["クロスプラットフォームロック msvcrt/fcntl"]
    end

    subgraph output["出力層"]
        REPORT_COMPLETE["完全レポート complete_analysis.md"]
        REPORT_APPLIED["適用ログ .apply_log.jsonl"]
        BACKUPS["バックアップ backups/*.bak"]
        CONSOLE["コンソール出力 進捗表示"]
    end

    subgraph storage["データストレージ"]
        PICKLE[".advice_index.pickle ベクトルインデックス"]
        META[".advice_index.meta.json メタデータ"]
        JSONL[".advice_index.jsonl ファイルインデックス"]
    end

    %% 接続関係 - メイン処理
    USER --> CLI
    USER --> BATCH_SCRIPT
    CLI --> MAIN
    BATCH_SCRIPT --> MAIN
    ENV --> MAIN

    MAIN --> INDEX
    INDEX --> ENCODE
    INDEX --> FILTER
    ENCODE --> JSONL
    FILTER --> JSONL
    INDEX --> META

    JSONL --> VECTOR
    VECTOR --> SEARCH
    SEARCH --> RULES
    RULES --> SEVERITY

    SEVERITY --> PARALLEL
    PARALLEL --> CACHE
    CACHE --> COMPLETE
    COMPLETE --> MARKDOWN
    MARKDOWN --> REPORT_COMPLETE

    %% 接続関係 - v4.0自動適用
    REPORT_COMPLETE --> APPLY_TOOL
    APPLY_TOOL --> PATH_VAL
    APPLY_TOOL --> BOM_DETECT
    PATH_VAL --> TOCTOU
    TOCTOU --> ATOMIC
    BOM_DETECT --> CHARDET
    CHARDET --> FALLBACK
    FALLBACK --> ATOMIC
    ATOMIC --> BACKUP
    BACKUP --> FILELOCK
    FILELOCK --> REPORT_APPLIED
    BACKUP --> BACKUPS
    APPLY_TOOL --> ROLLBACK

    MAIN --> CONSOLE
    APPLY_TOOL --> CONSOLE

    %% スタイル
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef outputStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef storageStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef v4newStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:3px

    class USER,CLI,ENV,BATCH_SCRIPT inputStyle
    class MAIN,INDEX,ENCODE,FILTER,RULES,SEVERITY,PARALLEL,VECTOR,SEARCH,CACHE,COMPLETE,MARKDOWN processStyle
    class REPORT_COMPLETE,REPORT_APPLIED,BACKUPS,CONSOLE outputStyle
    class PICKLE,META,JSONL storageStyle
    class APPLY_TOOL,PATH_VAL,TOCTOU,ATOMIC,BOM_DETECT,CHARDET,FALLBACK,BACKUP,ROLLBACK,FILELOCK v4newStyle
