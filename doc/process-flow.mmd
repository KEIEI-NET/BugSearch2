flowchart TD
    %% コードレビュー処理フロー図 v3.0.0 - GPT-5対応版

    Start([開始]) --> ENV_CHECK[環境設定確認<br/>.env: OPENAI_MODEL]
    ENV_CHECK --> MODEL_ROUTE{モデル判定}

    MODEL_ROUTE -->|gpt-5-codex| RESPONSES_API[Responses API<br/>/v1/responses]
    MODEL_ROUTE -->|gpt-4o/gpt-5系| CHAT_API[Chat Completions API<br/>/v1/chat/completions]

    RESPONSES_API --> INPUT{実行方法}
    CHAT_API --> INPUT

    INPUT -->|バッチファイル| BATCH[run_detailed_analysis_auto.bat]
    INPUT -->|コマンドライン| CMD{コマンド判定}

    BATCH --> AUTO_DETECT[ファイル数自動検出]
    AUTO_DETECT --> INDEX_START

    CMD -->|index| INDEX_START[インデックス作成開始]
    CMD -->|advise --all| REVIEW_ALL[全ファイル分析]
    CMD -->|advise --topk N| REVIEW_TOPK[上位N件分析]

    %% インデックス処理フロー
    INDEX_START --> SCAN[ファイルスキャン<br/>15,710ファイル]
    SCAN --> SIZE_CHECK{ファイルサイズ<br/>チェック}
    SIZE_CHECK -->|4MB以下| LANG_CHECK{言語チェック}
    SIZE_CHECK -->|4MB超| LOG_LARGE[large_files_over_limit.log<br/>に記録]
    LOG_LARGE --> NEXT_FILE

    LANG_CHECK -->|対象言語| DETECT_ENCODING[エンコーディング検出]
    LANG_CHECK -->|除外言語| NEXT_FILE[次のファイル]

    DETECT_ENCODING --> TRY_UTF8{UTF-8?}
    TRY_UTF8 -->|成功| READ_FILE[ファイル読み込み]
    TRY_UTF8 -->|失敗| TRY_CP932{CP932?}
    TRY_CP932 -->|成功| READ_FILE
    TRY_CP932 -->|失敗| TRY_SJIS{Shift-JIS?}
    TRY_SJIS -->|成功| READ_FILE
    TRY_SJIS -->|失敗| TRY_LATIN1{Latin-1?}
    TRY_LATIN1 -->|成功| READ_FILE
    TRY_LATIN1 -->|失敗| SKIP_FILE[ファイルスキップ]

    READ_FILE --> SAVE_INDEX[.advice_index.pickle<br/>保存]
    SKIP_FILE --> NEXT_FILE
    SAVE_INDEX --> NEXT_FILE

    NEXT_FILE --> MORE_FILES{残ファイル<br/>あり?}
    MORE_FILES -->|はい| SCAN
    MORE_FILES -->|いいえ| INDEX_COMPLETE[インデックス完了<br/>27.88秒]

    %% 危険度分析フロー
    INDEX_COMPLETE --> DANGER_ANALYSIS[危険度分析開始]
    REVIEW_ALL --> DANGER_ANALYSIS
    REVIEW_TOPK --> DANGER_ANALYSIS

    DANGER_ANALYSIS --> LOAD_DATA[インデックス読み込み]
    LOAD_DATA --> APPLY_RULES[ルール適用<br/>全15,710ファイル]

    APPLY_RULES --> CHECK_PROBLEMS{問題検出}
    CHECK_PROBLEMS --> CALC_SCORE[危険度スコア計算]

    CALC_SCORE --> CATEGORIZE[カテゴリ分類]
    CATEGORIZE --> CRITICAL[緊急: 392件<br/>スコア15以上]
    CATEGORIZE --> HIGH[高: 423件<br/>スコア10-14]
    CATEGORIZE --> MEDIUM[中: 1,785件<br/>スコア5-9]
    CATEGORIZE --> LOW[低: 0件<br/>スコア1-4]

    CRITICAL --> SAVE_DANGER[src_complete_danger_analysis.md<br/>生成]
    HIGH --> SAVE_DANGER
    MEDIUM --> SAVE_DANGER
    LOW --> SAVE_DANGER

    %% 概要レポート生成
    SAVE_DANGER --> OVERVIEW[create_overview_report.py<br/>実行]
    OVERVIEW --> CREATE_OVERVIEW[AI分析.md<br/>生成]

    %% 詳細分析フロー
    CREATE_OVERVIEW --> BATCH_PROCESS[バッチ処理開始<br/>2,600ファイル]

    BATCH_PROCESS --> BATCH1[バッチ1<br/>1-500]
    BATCH_PROCESS --> BATCH2[バッチ2<br/>501-1000]
    BATCH_PROCESS --> BATCH3[バッチ3<br/>1001-1500]
    BATCH_PROCESS --> BATCH4[バッチ4<br/>1501-2000]
    BATCH_PROCESS --> BATCH5[バッチ5<br/>2001-2500]
    BATCH_PROCESS --> BATCH6[バッチ6<br/>2501-2600]

    BATCH1 --> DETAIL1[analyze_dangerous_files_detailed.py 1]
    BATCH2 --> DETAIL2[analyze_dangerous_files_detailed.py 2]
    BATCH3 --> DETAIL3[analyze_dangerous_files_detailed.py 3]
    BATCH4 --> DETAIL4[analyze_dangerous_files_detailed.py 4]
    BATCH5 --> DETAIL5[analyze_dangerous_files_detailed.py 5]
    BATCH6 --> DETAIL6[analyze_dangerous_files_detailed.py 6]

    DETAIL1 --> AI_API{AI API呼び出し}
    AI_API -->|成功| RPT1[AI分析_詳細_改善版_batch1.md]
    AI_API -->|失敗| FALLBACK[フォールバック<br/>gpt-4o]
    FALLBACK --> RPT1
    DETAIL2 --> RPT2[AI分析_詳細_改善版_batch2.md]
    DETAIL3 --> RPT3[AI分析_詳細_改善版_batch3.md]
    DETAIL4 --> RPT4[AI分析_詳細_改善版_batch4.md]
    DETAIL5 --> RPT5[AI分析_詳細_改善版_batch5.md]
    DETAIL6 --> RPT6[AI分析_詳細_改善版_batch6.md]

    %% レポート統合
    RPT1 --> MERGE[merge_detailed_reports.py<br/>実行]
    RPT2 --> MERGE
    RPT3 --> MERGE
    RPT4 --> MERGE
    RPT5 --> MERGE
    RPT6 --> MERGE

    MERGE --> FINAL[AI分析_詳細_改善版_完全版.md<br/>24.3MB]

    FINAL --> End([完了])

    %% スタイル定義
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef process fill:#2196f3,stroke:#1565c0,stroke-width:2px,color:#fff
    classDef decision fill:#ff9800,stroke:#e65100,stroke-width:2px,color:#fff
    classDef batch fill:#9c27b0,stroke:#6a1b9a,stroke-width:2px,color:#fff
    classDef output fill:#00bcd4,stroke:#00838f,stroke-width:2px,color:#fff
    classDef danger fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff

    class Start,End startEnd
    class INDEX_START,SCAN,DETECT_ENCODING,READ_FILE,SAVE_INDEX,LOAD_DATA,APPLY_RULES,CALC_SCORE,OVERVIEW,BATCH_PROCESS,DETAIL1,DETAIL2,DETAIL3,DETAIL4,DETAIL5,DETAIL6,MERGE process
    class INPUT,CMD,SIZE_CHECK,LANG_CHECK,TRY_UTF8,TRY_CP932,TRY_SJIS,TRY_LATIN1,MORE_FILES,CHECK_PROBLEMS decision
    class BATCH,AUTO_DETECT,BATCH1,BATCH2,BATCH3,BATCH4,BATCH5,BATCH6 batch
    class CREATE_OVERVIEW,RPT1,RPT2,RPT3,RPT4,RPT5,RPT6,FINAL,SAVE_DANGER,LOG_LARGE output
    class CRITICAL,HIGH,MEDIUM,LOW danger