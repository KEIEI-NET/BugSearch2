# codex_review リポジトリ解析メモ

## <span style="color:#2E86AB;">全体概要</span>
- <span style="color:#28B463;">目的</span>: 金額・印刷・UI/UX・DB 負荷に関する指摘を、静的ルールと OpenAI ベースの解析で提示する CLI 群。
- <span style="color:#AF7AC5;">構成</span>: `codex_review*.py` に多数の派生版があり、機能差分（バッチ処理・重要度ソート・改善コード生成・2段階解析など）を個別ファイルで提供。
- <span style="color:#F39C12;">生成物</span>: `.advice_index.jsonl`、`.advice_tfidf.pkl`、`.advice_matrix.pkl` はインデックスと TF-IDF キャッシュ。`reports/` 以下は除外対象だが、各ツールが Markdown レポートを書き出す設計。
- <span style="color:#E74C3C;">注意</span>: README/SETUP/DOC 類は「ultimate 版」や 2 段階解析を想定しているが、実装は派生スクリプトに分散しており、一部記述（例: joblib 並列や二段階レポート）が実コードと乖離。

## <span style="color:#1ABC9C;">CLI スクリプト比較</span>
- <span style="color:#3498DB;">`codex_review.py`</span>: 基本版。UTF-8 読み込み・簡易タグ付与・最大 8 件のルール指摘。AI モードは上位 `HYBRID_TOPK_AI=5` 件を GPT-5 に渡す軽量構成。
- <span style="color:#9B59B6;">`codex_review_optimized.py`</span>: バッチ処理 (10件単位) と 240 秒タイムアウトで全件レビューに対応。AI は全候補をハイブリッドレビューし、各バッチ結果を統合出力。
- <span style="color:#D35400;">`codex_review_enhanced.py`</span>: chardet によるエンコーディング自動検出、重要度スコア算出、AI 改善案 (Before/After) 生成。レポートを重要度別にセクション分け。
- <span style="color:#C0392B;">`codex_review_severity.py`</span>: 重要度スコアに基づき並べ替え。エンコーディング検出はなく UTF-8 読み込みのまま。AI は上位 5 件で `gpt-4o` 既定。
- <span style="color:#E67E22;">`codex_review_with_solutions.py`</span>: バッチ (5 件) で詳細な改善案を生成し、AI には修正コードの Before/After を強制。ルール部分は基本版と同じ。
- <span style="color:#16A085;">`codex_review_ultimate.py`</span>: ドキュメントが推奨する 2 段階解析。Phase1 でルール＋改善例、Phase2 で高重要度のみ AI 詳細解析 (個別リトライ・進捗表示)。 `_rules.md` と `_ai.md` の 2 レポートを同時生成。

## <span style="color:#5DADE2;">ドキュメントとガイド</span>
- <span style="color:#F5B041;">`README.md`</span>: ツール群の機能一覧だが、「GPT-4o の修正コード生成」「全件処理」など一部は `optimized`/`ultimate` 側にのみ存在。未収録ファイル (`reports/IMPORTANT_RESULTS.md`) への参照あり。
- <span style="color:#52BE80;">`README_optimized.md`</span>: `codex_review_optimized.py` の運用マニュアル。GitHub Actions 連携手順とバッチ仕様、トラブルシュートを詳述。
- <span style="color:#48C9B0;">`SETUP_GUIDE.md`</span>: 2 段階解析 (ultimate) 前提でセットアップ方法を説明。ここでも未同梱リソースの記載がある点に注意。
- <span style="color:#BB8FCE;">`doc/`</span>: 技術仕様 (`TECHNICAL.md`)、開発履歴 (`DEVELOPMENT.md`)、Mermaid 図 (アーキテクチャ/フロー/シーケンス)。すべて ultimate 版を中心に説明しており、実装との差分がある。

## <span style="color:#EB984E;">設定・CI 関連</span>
- <span style="color:#45B39D;">`codex-readonly-review.yml`</span>: 配布用 GitHub Actions テンプレート。基本版 (`codex_review.py`) を想定し、ハイブリッド助言レポートを PR にコメント投稿。
- <span style="color:#2980B9;">`.github/workflows/codex-readonly-review-optimized.yml`</span>: 実運用向けワークフロー。`codex_review_optimized.py` を使用し、TF-IDF の再生成・PR 差分ログ・summary.md コメントを自動化。
- <span style="color:#2471A3;">`.env.example`</span>: `OPENAI_API_KEY` と `OPENAI_MODEL` の最小テンプレート。`.env` は実値が入るため参照せず、コミット除外。
- <span style="color:#A93226;">`.claude/settings.local.json`</span>: CLI 操作許可を列挙する補助設定 (git/pip/python コマンドを無承認で許可)。
- <span style="color:#7D3C98;">`.gitignore`</span>: `.env` や `.advice*`、`reports/`、`src/*` を無視設定。現状リポジトリ直下に生成物があるため、配布時はクリーン化が必要。

## <span style="color:#EC7063;">生成キャッシュとその他ファイル</span>
- <span style="color:#148F77;">`.advice_index.jsonl`</span>: 現在のリポジトリ内容がインデックス済み (例: `MAKAU09174R/...` の C# ファイル群)。派生スクリプトもこのフォーマットを期待。
- <span style="color:#117A65;">`.advice_tfidf.pkl` / `.advice_matrix.pkl`</span>: scikit-learn の TF-IDF ベクトルと行列。環境によっては存在しない前提でフォールバックする実装。
- <span style="color:#7F8C8D;">ライセンス</span>: `LICENSE` は MIT だが、`README_optimized.md` 末尾では「ライセンス未指定」と記載しており整合が取れていない。
- <span style="color:#5D6D7E;">その他</span>: `AGENTS.md` はリポジトリ運用ルール、`.github` 配下のワークフローファイルが CI に対応。`reports/` と `src/` は今回指示により解析対象外。

## <span style="color:#AF601A;">ギャップと留意点</span>
- <span style="color:#F4D03F;">ドキュメントとの乖離</span>: TECHNICAL/SETUP では joblib 並列や 2 段階レポートが標準仕様のように記載されているが、実際の `codex_review.py` には未実装。採用時は利用バージョンに合わせたドキュメント整備が必要。
- <span style="color:#E59866;">AI モデル</span>: 多くの派生版で `OPENAI_MODEL` の既定を `gpt-5` と記載しつつ、実装では `gpt-4o` をフォールバックに使う箇所がある（空応答対策）。CI で利用するモデル指定を合わせる必要がある。
- <span style="color:#CD6155;">生成物共有</span>: `.advice*` や `.env` がリポジトリ直下に存在するため、クリーンな配布パッケージを作る際は削除または無視設定の確認が必須。
- <span style="color:#566573;">バージョン管理</span>: `codex_review_ultimate.py` を含め CLI が複数併存しているため、機能追加時はどのエディションを更新するか明示しないとドキュメントとの齟齬が拡大する恐れ。

> ※ 指定に従い `src/` と `reports/` 以下は解析対象から除外しました。
