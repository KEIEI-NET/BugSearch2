%%{init: {'theme':'dark'}}%%
graph TB
    %% BugSearch2 GUI Production v1.0.0 Architecture
    %% Created: 2025-10-21
    %% Author: KEIEI.NET INC.

    subgraph "GUI Production v1.0.0"
        GUI[gui_production.py<br/>Main Application<br/>590 lines]
    end

    subgraph "UI Layer - CustomTkinter"
        subgraph "3-Tab Interface"
            TAB1[Index Tab<br/>File Analysis]
            TAB2[Advise Tab<br/>AI Analysis]
            TAB3[Query Tab<br/>Search]
        end

        subgraph "UI Components"
            PROG[Progress Bar<br/>Real-time Update]
            LOG[Log Viewer<br/>Colored Output]
            COUNT[File Counter<br/>12,500/34,125]
            SPEED[Speed Display<br/>97 files/sec]
            ETA[ETA Calculator<br/>5分52秒]
        end
    end

    subgraph "Process Management"
        PROC[subprocess.Popen<br/>Unbuffered Mode]
        ENV[Environment<br/>PYTHONUNBUFFERED=1]
        PIPE[Pipe Management<br/>stdout/stderr]
    end

    subgraph "Threading System"
        THREAD[threading.Thread<br/>Background Worker]
        QUEUE[queue.Queue<br/>Thread Communication]
        LOCK[Thread Lock<br/>Synchronization]
    end

    subgraph "Progress Tracking"
        PARSE[Log Parser<br/>Regex Patterns]
        CALC[Progress Calculator<br/>Moving Average]
        MSG[Preparation Messages<br/>Status Updates]
    end

    subgraph "CLI Integration"
        INDEX_CMD[codex_review_severity.py index]
        ADVISE_CMD[codex_review_severity.py advise]
        QUERY_CMD[codex_review_severity.py query]
    end

    subgraph "Real-time Features"
        STREAM[Line-buffered Stream<br/>bufsize=1]
        UPDATE[UI Update Loop<br/>100ms interval]
        REGEX[Pattern Matching<br/>Progress Detection]
    end

    %% Connections
    GUI --> TAB1
    GUI --> TAB2
    GUI --> TAB3

    TAB1 --> INDEX_CMD
    TAB2 --> ADVISE_CMD
    TAB3 --> QUERY_CMD

    TAB1 --> PROG
    TAB1 --> COUNT
    TAB2 --> LOG
    TAB2 --> SPEED
    TAB3 --> ETA

    INDEX_CMD --> PROC
    ADVISE_CMD --> PROC
    QUERY_CMD --> PROC

    PROC --> ENV
    PROC --> PIPE
    PROC --> STREAM

    PIPE --> THREAD
    THREAD --> QUEUE
    THREAD --> PARSE

    PARSE --> REGEX
    PARSE --> CALC
    CALC --> UPDATE

    UPDATE --> PROG
    UPDATE --> COUNT
    UPDATE --> SPEED
    UPDATE --> ETA
    UPDATE --> LOG

    QUEUE --> LOCK
    LOCK --> UPDATE

    MSG --> LOG

    %% Performance Box
    subgraph "Production Metrics"
        METRICS["""
        実績データ:
        - 処理ファイル数: 34,125
        - 処理時間: 5分52秒
        - 平均速度: 97 files/sec
        - メモリ使用: 512MB
        - CPU使用率: 25%
        - エラー率: 0%
        """]
    end

    %% Styling
    classDef main fill:#dc2626,stroke:#ef4444,stroke-width:3px,color:#fff
    classDef ui fill:#2d3748,stroke:#4a5568,stroke-width:2px,color:#fff
    classDef process fill:#1a365d,stroke:#2c5282,stroke-width:2px,color:#fff
    classDef thread fill:#065666,stroke:#0e7490,stroke-width:2px,color:#fff
    classDef cli fill:#5b21b6,stroke:#7c3aed,stroke-width:2px,color:#fff
    classDef realtime fill:#7c2d12,stroke:#ea580c,stroke-width:2px,color:#fff
    classDef metrics fill:#065f46,stroke:#10b981,stroke-width:2px,color:#fff

    class GUI main
    class TAB1,TAB2,TAB3,PROG,LOG,COUNT,SPEED,ETA ui
    class PROC,ENV,PIPE process
    class THREAD,QUEUE,LOCK thread
    class INDEX_CMD,ADVISE_CMD,QUERY_CMD cli
    class STREAM,UPDATE,REGEX,PARSE,CALC,MSG realtime
    class METRICS metrics

    %% Sequence Flow
    subgraph "Execution Flow"
        direction LR
        START[User Click] --> SPAWN[Spawn Process]
        SPAWN --> READ[Read Output]
        READ --> PARSER[Parse Progress]
        PARSER --> DISPLAY[Update UI]
        DISPLAY --> COMPLETE[Complete]
    end

    style START fill:#059669,stroke:#10b981
    style COMPLETE fill:#dc2626,stroke:#ef4444