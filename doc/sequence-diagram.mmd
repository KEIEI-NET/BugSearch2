```mermaid
sequenceDiagram
    %% ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

    participant User as ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant CLI as ğŸ“Ÿ CLI
    participant Main as ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
    participant Index as ğŸ“š ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    participant Encoder as ğŸ”¤ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼
    participant Rules as ğŸ“ ãƒ«ãƒ¼ãƒ«è§£æ
    participant AI as ğŸ¤– AIè§£æ
    participant Report as ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆ

    %% ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    rect rgb(240, 248, 255)
        note over User,Report: Phase 1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
        User->>CLI: py codex_review_ultimate.py index .
        CLI->>Main: parse_args(["index", "."])
        Main->>Index: create_index(path, exclude_langs, max_file_mb)

        loop å„ãƒ•ã‚¡ã‚¤ãƒ«
            Index->>Index: check_file_size()
            alt ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºOK
                Index->>Encoder: detect_encoding(file_path)
                Encoder-->>Index: encoding (utf-8/cp932/euc-jp)
                Index->>Index: read_file(encoding)
                Index->>Index: save_to_jsonl()
            else ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…é
                Index->>Index: log_large_file()
            end
        end

        Index-->>Main: index_complete
        Main-->>CLI: "Indexed X files"
        CLI-->>User: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    end

    %% ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    rect rgb(255, 243, 224)
        note over User,Report: Phase 2: ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        User->>CLI: py codex_review_ultimate.py vectorize
        CLI->>Main: parse_args(["vectorize"])
        Main->>Index: load_index()
        Index-->>Main: documents
        Main->>Main: create_tfidf_vectorizer()
        Main->>Main: fit_transform(documents)
        Main->>Main: save_vectorizer()
        Main-->>CLI: "Vectorization complete"
        CLI-->>User: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    end

    %% ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    rect rgb(240, 255, 240)
        note over User,Report: Phase 3: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        User->>CLI: py codex_review_ultimate.py query "keyword" --topk 50
        CLI->>Main: parse_args(["query", "keyword", "--topk", "50"])
        Main->>Index: load_index()
        Main->>Main: search_similar(keyword, topk)

        %% ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è§£æ
        rect rgb(255, 240, 245)
            note over Main,Report: Sub-Phase 3.1: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è§£æ
            Main->>Rules: analyze_all_files(documents)

            loop å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
                Rules->>Rules: apply_rules(text)
                Rules->>Rules: detect_n_plus_one()
                Rules->>Rules: detect_select_star()
                Rules->>Rules: detect_float_money()
                Rules->>Rules: detect_xss()
                Rules->>Rules: calculate_severity_score()
                Rules->>Rules: generate_sample_fix()
            end

            Rules->>Rules: sort_by_severity()
            Rules->>Report: write_rules_report()
            Rules-->>Main: rule_results
        end

        %% AIè§£æ
        rect rgb(245, 245, 255)
            note over Main,Report: Sub-Phase 3.2: AIè§£æï¼ˆé«˜é‡è¦åº¦ã®ã¿ï¼‰
            Main->>Main: filter_high_severity(rule_results)
            Main->>AI: analyze_with_ai(high_severity_files)

            loop å„é«˜é‡è¦åº¦ãƒ•ã‚¡ã‚¤ãƒ« (æœ€å¤§20)
                AI->>AI: show_progress(i/total)
                AI->>AI: prepare_prompt(file_content, issues)
                AI->>AI: call_openai_api(timeout=60)

                alt APIæˆåŠŸ
                    AI->>AI: parse_response()
                    AI->>AI: extract_before_after()
                    AI->>AI: format_improvements()
                else ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ã‚¨ãƒ©ãƒ¼
                    alt ãƒªãƒˆãƒ©ã‚¤å¯èƒ½
                        AI->>AI: retry_api_call()
                    else ãƒªãƒˆãƒ©ã‚¤ä¸å¯
                        AI->>AI: log_skip()
                    end
                end
            end

            AI->>Report: write_ai_report()
            AI-->>Main: ai_results
        end

        Main-->>CLI: "Analysis complete"
        CLI-->>User: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†
    end

    %% ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    rect rgb(255, 230, 230)
        note over User,Report: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        alt OpenAI APIã‚¨ãƒ©ãƒ¼
            AI->>Main: APIException
            Main->>Main: handle_api_error()
            Main-->>CLI: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        else ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼
            Encoder->>Index: EncodingError
            Index->>Index: try_alternative_encoding()
        else å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«
            Index->>Index: log_and_skip()
        end
    end
```
